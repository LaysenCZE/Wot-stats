import React, { useEffect, useMemo, useState } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogTrigger } from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Skeleton } from "@/components/ui/skeleton";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { Switch } from "@/components/ui/switch";
import { motion } from "framer-motion";
import { Info, Moon, SunMedium, Search, Swords, Target, Gauge, Trophy, ShieldCheck, TrendingUp, Skull, AlertCircle } from "lucide-react";
import { PieChart, Pie, Cell, ResponsiveContainer, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip as RTooltip, Legend, LineChart, Line } from "recharts";


/**
* WoT Stats – Jednostránková aplikace
*
* Funkce:
* - Hledání hráčů (nickname -> account_id) přes Wargaming Public API
* - Přehled hráče: bitvy, výhry, prohry, winrate, celkové DMG, průměr DMG, zničená vozidla
* - Grafy: výhry vs prohry (bar), přehled metrik (line), koláč výher/proher
* - Garáž tanků: obrázek, tier, bitvy, výhry/prohry, celkové DMG, průměr DMG, zničené vozidla
* - Tmavý režim (toggle), pestrá animovaná tlačítka, Info/Novinky (Dialog)
*
* POZN.: Vyžaduje WG API APP ID (viz const WG_APP_ID). Pro provoz na frontendu může být potřeba CORS proxy.
*/


// TODO: nastavte své WG APP ID
const WG_APP_ID = process.env.NEXT_PUBLIC_WG_APP_ID || "YOUR_WG_APP_ID"; // vložte klíč nebo nastavte ENV


// Regiony API
const REGIONS = {
eu: "https://api.worldoftanks.eu",
na: "https://api.worldoftanks.com",
asia: "https://api.worldoftanks.asia",
ru: "https://api.worldoftanks.ru",
} as const;


// Malá paleta pro koláč
const PIE_KEYS = ["#3b82f6", "#ef4444"];


// Sjednocení fetch s chybami
async function getJSON(url: string) {
const res = await fetch(url);
if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
const data = await res.json();
if (data?.status !== "ok") {
const msg = data?.error?.message || "Neznámá chyba API";
throw new Error(msg);
}
return data;
}


function formatPct(n: number) {
return (n * 100).toFixed(2) + "%";
}


function niceInt(n: number | undefined | null) {
if (!n && n !== 0) return "-";
return n.toLocaleString("cs-CZ");
}


export default function WoTStatsApp() {
const [dark, setDark] = useState<boolean>(true);
const [region, setRegion] = useState<keyof typeof REGIONS>("eu");
const [query, setQuery] = useState("");
const [loading, setLoading] = useState(false);
const [error, setError] = useState<string | null>(null);
const [player, setPlayer] = useState<any | null>(null); // account/info
const [tanks, setTanks] = useState<any[]>([]); // tanks/stats
const [ency, setEncy] = useState<Record<string, any>>({}); // vehicles encyclopedia by tank_id


// Dark mode
useEffect(() => {
const root = document.documentElement;
if (dark) root.classList.add("dark"); else root.classList.remove("dark");
}, [dark]);


// Changelog – upravujte podle potřeby
const changelog = [
{ date: "2025-09-13", items: ["První verze: hledání hráčů, přehled, grafy, garáž.", "Tmavý režim + animovaná barevná tlačítka.", "Info/Novinky v modalu."] },
];


async function searchPlayer() {
setError(null);
setPlayer(null);
