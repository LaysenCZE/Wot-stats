<!DOCTYPE html>
<html lang="cs" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WoT Stats ‚Äì stable v4</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={darkMode:'class'};</script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .card{ background: rgba(15,23,42,.6); border:1px solid rgba(255,255,255,.1); border-radius: 16px; }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; border-radius:16px; padding:.5rem 1rem; font-weight:600; border:1px solid rgba(255,255,255,.1); transition:transform .08s ease; }
    .btn:active{ transform: scale(.97); }
    .btn-primary{ background-image: linear-gradient(135deg,#2563eb,#06b6d4); }
    .btn-emerald{ background-image: linear-gradient(135deg,#059669,#0d9488); }
    .btn-purple{ background-image: linear-gradient(135deg,#4f46e5,#d946ef); }
    .chip{ font-size:.75rem; padding:.125rem .5rem; border-radius:9999px; background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.1); }
    .badge{ font-size:.75rem; padding:.1rem .5rem; border-radius:9999px; border:1px solid currentColor; }
    .modal{ position:fixed; inset:0; z-index:50; display:none; }
    .modal.open{ display:block; }
    .modal-backdrop{ position:absolute; inset:0; background: rgba(0,0,0,.6); }
    .modal-body{ position:relative; margin:4rem auto 0; max-width:720px; }
    #loader{ position:fixed; inset:0; z-index:100; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.6); }
    #loader.show{ display:flex; }
    .spinner{ width:56px; height:56px; border:5px solid rgba(255,255,255,.2); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform: rotate(360deg);} }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-900 via-slate-950 to-black text-slate-100">
  <div id="loader"><div class="spinner"></div></div>
  <header class="sticky top-0 z-40 backdrop-blur bg-slate-900/80 border-b border-white/5">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="chip">beta</span>
        <h1 class="text-xl font-bold">WoT Stats</h1>
      </div>
      <div class="flex items-center gap-2">
        <select id="region" class="bg-slate-800/70 border border-white/10 rounded-xl px-3 py-2">
          <option value="eu" selected>EU</option>
          <option value="na">NA</option>
          <option value="asia">ASIA</option>
          <option value="ru">RU</option>
        </select>
        <button id="toggleTheme" class="btn btn-purple" title="P≈ôepnout t√©ma"><span data-lucide="sun"></span><span class="hidden md:inline">T√©ma</span></button>
        <button id="openInfo" class="btn btn-emerald"><span data-lucide="info"></span><span class="hidden md:inline">Info & Novinky</span></button>
      </div>
    </div>
  </header>

  <!-- Info modal -->
  <div id="infoModal" class="modal">
    <div class="modal-backdrop" onclick="closeModal('infoModal')"></div>
    <div class="modal-body">
      <div class="card p-6">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">O str√°nce</h3>
          <button class="btn" onclick="closeModal('infoModal')">Zav≈ô√≠t</button>
        </div>
        <p class="text-slate-300 mb-4">Stabiln√≠ v4 ‚Ä¢ P≈ôid√°no: Porovn√°n√≠ hr√°ƒç≈Ø, ≈Ωeb≈ô√≠ƒçek, grafy gar√°≈æe (t≈ô√≠dy + top bitvy), Klanov√© statistiky, emotikony a barvy t≈ô√≠d.</p>
      </div>
    </div>
  </div>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-8">
    <!-- Hled√°n√≠ hr√°ƒçe -->
    <section class="card p-4">
      <div class="grid gap-3 md:grid-cols-[1fr_auto] items-center">
        <input id="playerInput" class="bg-slate-800/70 border border-white/10 rounded-xl px-3 py-2" placeholder="Hledat hr√°ƒçe (nickname)‚Ä¶" />
        <button id="searchBtn" class="btn btn-primary"><span data-lucide="search"></span>Hledat hr√°ƒçe</button>
      </div>
      <p id="errorBox" class="mt-2 text-red-400 hidden"></p>
      <p class="mt-2 text-slate-400 text-sm">Tip: Enter spust√≠ hled√°n√≠. Lze tak√© `?player=nickname`.</p>
    </section>

    <!-- V√Ωstup hr√°ƒçe -->
    <section id="playerSection" class="hidden space-y-6">
      <div class="flex flex-wrap items-end justify-between gap-4">
        <div>
          <h2 id="playerName" class="text-2xl font-bold">‚Äî</h2>
          <div class="text-slate-400 text-sm">Region: <span id="playerRegion">EU</span> ‚Ä¢ ID: <span id="playerId">‚Äî</span> ‚Ä¢ Posledn√≠ bitva: <span id="lastBattle">‚Äî</span></div>
        </div>
      </div>
      <div class="grid md:grid-cols-3 gap-4">
        <div class="card p-4"><div class="text-xs text-slate-400">Bitvy</div><div id="kpiBattles" class="text-xl font-semibold">-</div></div>
        <div class="card p-4"><div class="text-xs text-slate-400">V√Ωhry</div><div id="kpiWins" class="text-xl font-semibold">-</div></div>
        <div class="card p-4"><div class="text-xs text-slate-400">Prohry</div><div id="kpiLosses" class="text-xl font-semibold">-</div></div>
        <div class="card p-4"><div class="text-xs text-slate-400">Winrate</div><div id="kpiWR" class="text-xl font-semibold">-</div></div>
        <div class="card p-4"><div class="text-xs text-slate-400">DMG celkem</div><div id="kpiDmg" class="text-xl font-semibold">-</div></div>
        <div class="card p-4"><div class="text-xs text-slate-400">Pr≈Ømƒõr DMG / bitvu</div><div id="kpiAvg" class="text-xl font-semibold">-</div></div>
      </div>

      <div class="grid md:grid-cols-3 gap-4">
        <div class="card p-4"><h3 class="font-semibold mb-2">V√Ωhry vs Prohry</h3><canvas id="barWinLoss" height="200"></canvas></div>
        <div class="card p-4"><h3 class="font-semibold mb-2">Pod√≠l v√Ωher/proher</h3><canvas id="pieWinLoss" height="200"></canvas></div>
        <div class="card p-4"><h3 class="font-semibold mb-2">Top 10 tank≈Ø podle DMG</h3><canvas id="barTopDmg" height="200"></canvas></div>
      </div>

      <!-- Extra grafy gar√°≈æe -->
      <div class="grid md:grid-cols-2 gap-4">
        <div class="card p-4"><h3 class="font-semibold mb-2">Rozlo≈æen√≠ podle t≈ô√≠d</h3><canvas id="pieClasses" height="220"></canvas></div>
        <div class="card p-4"><h3 class="font-semibold mb-2">Top 10 podle poƒçtu bitev</h3><canvas id="barTopBattles" height="220"></canvas></div>
      </div>

      <!-- Gar√°≈æ -->
      <section class="space-y-3">
        <h3 class="text-xl font-semibold">Gar√°≈æ tank≈Ø</h3>
        <div id="garageGrid" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
      </section>
    </section>

    <!-- Porovn√°n√≠ hr√°ƒç≈Ø -->
    <section class="card p-4">
      <h3 class="font-semibold mb-3">Porovn√°n√≠ hr√°ƒç≈Ø</h3>
      <div class="grid md:grid-cols-[1fr_1fr_auto] gap-3 items-center">
        <input id="cmpA" class="bg-slate-800/70 border border-white/10 rounded-xl px-3 py-2" placeholder="Hr√°ƒç A" />
        <input id="cmpB" class="bg-slate-800/70 border border-white/10 rounded-xl px-3 py-2" placeholder="Hr√°ƒç B" />
        <button id="cmpBtn" class="btn btn-emerald"><span data-lucide="git-compare"></span>Porovnat</button>
      </div>
      <div id="cmpResult" class="mt-4 hidden">
        <div class="grid md:grid-cols-2 gap-4">
          <div class="card p-4"><h4 id="cmpNameA" class="font-semibold mb-2">‚Äî</h4><div id="cmpKpiA" class="grid grid-cols-2 gap-2"></div></div>
          <div class="card p-4"><h4 id="cmpNameB" class="font-semibold mb-2">‚Äî</h4><div id="cmpKpiB" class="grid grid-cols-2 gap-2"></div></div>
        </div>
        <div class="card p-4 mt-4"><h4 class="font-semibold mb-2">A vs B</h4><canvas id="cmpChart" height="160"></canvas></div>
      </div>
    </section>

    <!-- Klanov√© statistiky -->
    <section class="card p-4">
      <h3 class="font-semibold mb-3">Klanov√© statistiky</h3>
      <div class="grid md:grid-cols-[1fr_auto] gap-3 items-center">
        <input id="clanInput" class="bg-slate-800/70 border border-white/10 rounded-xl px-3 py-2" placeholder="Hledat klan (tag nebo n√°zev)‚Ä¶" />
        <button id="clanBtn" class="btn btn-primary"><span data-lucide="search"></span>Naj√≠t klan</button>
      </div>
      <div id="clanResult" class="mt-4 hidden"></div>
    </section>

    <!-- ≈Ωeb≈ô√≠ƒçek -->
    <section class="card p-4">
      <h3 class="font-semibold mb-3">≈Ωeb≈ô√≠ƒçek hr√°ƒç≈Ø (seznam p≈ôezd√≠vek)</h3>
      <div class="grid md:grid-cols-[1fr_auto_auto] gap-3 items-center">
        <input id="lbInput" class="bg-slate-800/70 border border-white/10 rounded-xl px-3 py-2" placeholder="Nap≈ô.: LaysenCZECH, PlayerTwo, PlayerThree" />
        <select id="lbMetric" class="bg-slate-800/70 border border-white/10 rounded-xl px-3 py-2">
          <option value="wr" selected>Winrate</option>
          <option value="battles">Bitvy</option>
          <option value="dmg">Celkov√Ω DMG</option>
          <option value="avg">Pr≈Øm. DMG</option>
        </select>
        <button id="lbBtn" class="btn btn-primary">Naƒç√≠st ≈æeb≈ô√≠ƒçek</button>
      </div>
      <div id="lbResult" class="mt-4 hidden">
        <div class="overflow-x-auto"><table class="w-full text-sm" id="lbTable"></table></div>
        <div class="card p-4 mt-4"><h4 class="font-semibold mb-2">Graf ≈æeb≈ô√≠ƒçku</h4><canvas id="lbChart" height="180"></canvas></div>
      </div>
    </section>
  </main>

  <!-- Tank modal -->
  <div id="tankModal" class="modal">
    <div class="modal-backdrop" onclick="closeModal('tankModal')"></div>
    <div class="modal-body">
      <div class="card p-0 overflow-hidden">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
          <div>
            <h4 id="tankTitle" class="font-semibold">Tank</h4>
            <div id="tankMeta" class="text-xs text-slate-400">‚Äî</div>
          </div>
          <button class="btn" onclick="closeModal('tankModal')">Zav≈ô√≠t</button>
        </div>
        <div class="p-4 grid md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <img id="tankImage" class="w-full h-40 object-contain bg-slate-800 rounded-xl" />
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div><div class="text-xs text-slate-400">Bitvy</div><div id="tdBattles" class="font-semibold">-</div></div>
              <div><div class="text-xs text-slate-400">V√Ωhry</div><div id="tdWins" class="font-semibold">-</div></div>
              <div><div class="text-xs text-slate-400">Prohry</div><div id="tdLosses" class="font-semibold">-</div></div>
              <div><div class="text-xs text-slate-400">Pr≈Øm. DMG</div><div id="tdAvg" class="font-semibold">-</div></div>
              <div><div class="text-xs text-slate-400">DMG celkem</div><div id="tdDmg" class="font-semibold">-</div></div>
              <div><div class="text-xs text-slate-400">Zniƒçen√©</div><div id="tdFrags" class="font-semibold">-</div></div>
            </div>
          </div>
          <div class="space-y-2">
            <h5 class="font-semibold">Mini grafy</h5>
            <div class="h-[180px]"><canvas id="tankPie"></canvas></div>
            <div class="h-[180px]"><canvas id="tankBar"></canvas></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  const WG_APP_ID = "028df7d564e4447b29c6c3ee894142cb";
  const REGIONS = { eu:'https://api.worldoftanks.eu', na:'https://api.worldoftanks.com', asia:'https://api.worldoftanks.asia', ru:'https://api.worldoftanks.ru' };
  const COLORS = { win:'#10b981', loss:'#ef4444', dmg:'#60a5fa', battles:'#94a3b8', A:'#38bdf8', B:'#f97316' };
  const CLASS_META = {
    heavyTank : { emoji:'üü•', color:'#ef4444', label:'heavyTank' },
    mediumTank: { emoji:'üü©', color:'#22c55e', label:'mediumTank' },
    lightTank : { emoji:'üü®', color:'#eab308', label:'lightTank' },
    'AT-SPG'  : { emoji:'üü™', color:'#a855f7', label:'AT-SPG' },
    SPG       : { emoji:'üüß', color:'#f59e0b', label:'SPG' },
  };

  // ====== UTILS ======
  const $ = (s)=> document.querySelector(s);
  const $c = (t,cls)=>{ const e=document.createElement(t); if(cls) e.className=cls; return e; };
  const show = (id)=> document.getElementById(id).classList.add('open');
  const hide = (id)=> document.getElementById(id).classList.remove('open');
  function openModal(id){ show(id); document.body.style.overflow='hidden'; }
  function closeModal(id){ hide(id); document.body.style.overflow=''; }
  function fmt(n){ return (n??0).toLocaleString('cs-CZ'); }
  function pct(n){ return ((n||0)*100).toFixed(2)+'%'; }
  function ts(ts){ return ts? new Date(ts*1000).toLocaleString('cs-CZ'):'‚Äî'; }
  const loader = { on(){ $('#loader').classList.add('show'); }, off(){ $('#loader').classList.remove('show'); } };

  // Chart.js dark defaults
  (function applyChartDark(){ if(!window.Chart)return; Chart.defaults.color='#e2e8f0'; Chart.defaults.borderColor='rgba(148,163,184,.25)'; Chart.defaults.font={size:13}; if(Chart.defaults.plugins && Chart.defaults.plugins.legend && Chart.defaults.plugins.legend.labels){ Chart.defaults.plugins.legend.labels.color='#e2e8f0'; } })();

  // ====== API ======
  async function getJSON(url){ const r=await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status); const j=await r.json(); if(j.status!=='ok') throw new Error(j?.error?.message||'Chyba API'); return j.data; }
  async function searchAccount(nick, region){ const u=`${REGIONS[region]}/wot/account/list/?application_id=${WG_APP_ID}&search=${encodeURIComponent(nick)}&limit=1`; const d=await getJSON(u); return d?.[0]||null; }
  async function accountInfo(id, region){ const u=`${REGIONS[region]}/wot/account/info/?application_id=${WG_APP_ID}&account_id=${id}`; const d=await getJSON(u); return d?.[id]; }
  async function tanksStats(id, region){ const u=`${REGIONS[region]}/wot/tanks/stats/?application_id=${WG_APP_ID}&account_id=${id}`; const d=await getJSON(u); return d?.[id]||[]; }
  async function vehiclesByIds(ids, region){ const out={}; const chunks=(a,n)=> a.length?[a.slice(0,n),...chunks(a.slice(n),n)]:[]; for(const part of chunks(ids, 90)){ const u=`${REGIONS[region]}/wot/encyclopedia/vehicles/?application_id=${WG_APP_ID}&tank_id=${part.join(',')}`; Object.assign(out, await getJSON(u)); } return out; }
  async function clanSearch(q, region){ const u=`${REGIONS[region]}/wot/clans/list/?application_id=${WG_APP_ID}&search=${encodeURIComponent(q)}&limit=1`; const d=await getJSON(u); return d?.[0]||null; }
  async function clanInfo(id, region){ const u=`${REGIONS[region]}/wot/clans/info/?application_id=${WG_APP_ID}&clan_id=${id}`; const d=await getJSON(u); return d?.[id]; }

  // ====== EVENTS ======
  document.getElementById('toggleTheme').addEventListener('click', ()=> document.documentElement.classList.toggle('dark'));
  document.getElementById('openInfo').addEventListener('click', ()=> openModal('infoModal'));

  // hled√°n√≠ hr√°ƒçe
  document.getElementById('searchBtn').addEventListener('click', async ()=>{
    const nick = $('#playerInput').value.trim(); const region=$('#region').value; if(!nick) return;
    $('#errorBox').classList.add('hidden'); loader.on();
    try{
      const acc = await searchAccount(nick, region); if(!acc) throw new Error('Hr√°ƒç nenalezen');
      const [info, tstats] = await Promise.all([accountInfo(acc.account_id, region), tanksStats(acc.account_id, region)]);
      const ids = [...new Set(tstats.map(t=>t.tank_id))]; const vmap = await vehiclesByIds(ids, region);
      renderPlayer(acc, info, tstats, vmap, region);
    }catch(e){ $('#errorBox').textContent = e.message||String(e); $('#errorBox').classList.remove('hidden'); }
    finally{ loader.off(); }
  });
  document.getElementById('playerInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); document.getElementById('searchBtn').click(); }});
  document.addEventListener('DOMContentLoaded', ()=>{ const p=new URL(location.href).searchParams.get('player'); if(p){ $('#playerInput').value=p; document.getElementById('searchBtn').click(); } else { $('#playerInput').focus(); } lucide.createIcons(); });

  // ====== RENDER HELPERS ======
  let CHARTS={}; function upsert(ref, ctx, cfg){ if(CHARTS[ref]){ CHARTS[ref].data=cfg.data; CHARTS[ref].options=cfg.options||{}; CHARTS[ref].update(); } else { CHARTS[ref]=new Chart(ctx, cfg); } }

  function enrichGarage(tstats, vmap){
    return tstats.map(t=>{ const v=vmap?.[t.tank_id]||{}; const a=t.all||{}; const b=a.battles||0; const w=a.wins||0; const d=a.damage_dealt||0; const avg=b?Math.round(d/b):0; const fr=a.frags||0; const meta=CLASS_META[v.type]||{}; return { id:t.tank_id, name:v.name||('Tank '+t.tank_id), tier:v.tier||'?', img:v?.images?.big_icon||v?.images?.small_icon||'', cls:v.type||'', nation:v.nation||'', clsEmoji:meta.emoji||'', clsColor:meta.color||'#9aa1af', battles:b, wins:w, losses:Math.max(0,b-w-(a.draws||0)), dmg:d, avg, frags:fr }; }).sort((A,B)=>B.battles-A.battles);
  }

  function renderPlayer(acc, info, tstats, vmap, region){
    const s = info?.statistics?.all||{}; const battles=s.battles||0; const wins=s.wins||0; const draws=s.draws||0; const losses=Math.max(0,battles-wins-draws); const dmg=s.damage_dealt||0; const avg=battles?Math.round(dmg/battles):0; const wr=battles?wins/battles:0;
    $('#playerSection').classList.remove('hidden');
    $('#playerName').textContent = acc.nickname; $('#playerRegion').textContent = region.toUpperCase(); $('#playerId').textContent = acc.account_id; $('#lastBattle').textContent = ts(info?.last_battle_time);
    $('#kpiBattles').textContent=fmt(battles); $('#kpiWins').textContent=fmt(wins); $('#kpiLosses').textContent=fmt(losses); $('#kpiWR').textContent=pct(wr); $('#kpiDmg').textContent=fmt(dmg); $('#kpiAvg').textContent=fmt(avg);

    upsert('barWinLoss', $('#barWinLoss'), { type:'bar', data:{ labels:['V√Ωhry','Prohry'], datasets:[{ label:'Poƒçet', data:[wins,losses], backgroundColor:[COLORS.win,COLORS.loss] }] } });
    upsert('pieWinLoss', $('#pieWinLoss'), { type:'pie', data:{ labels:['V√Ωhry','Prohry'], datasets:[{ label:'Pod√≠l', data:[wins,losses], backgroundColor:[COLORS.win,COLORS.loss] }] } });

    const garage = enrichGarage(tstats, vmap);
    const topD = [...garage].sort((A,B)=>B.dmg-A.dmg).slice(0,10);
    upsert('barTopDmg', $('#barTopDmg'), { type:'bar', data:{ labels: topD.map(g=> `${g.clsEmoji} ${g.name}`), datasets:[{ label:'Celkov√Ω DMG', data: topD.map(g=>g.dmg), backgroundColor: topD.map(()=>COLORS.dmg) }] }, options:{ indexAxis:'y' } });

    // Extra: rozlo≈æen√≠ podle t≈ô√≠d + top podle bitev
    const byClass = {}; garage.forEach(g=>{ byClass[g.cls] = (byClass[g.cls]||0) + 1; });
    const classKeys = Object.keys(byClass);
    upsert('pieClasses', $('#pieClasses'), { type:'doughnut', data:{ labels: classKeys.map(k=> `${CLASS_META[k]?.emoji||''} ${CLASS_META[k]?.label||k}`), datasets:[{ data: classKeys.map(k=> byClass[k]), backgroundColor: classKeys.map(k=> CLASS_META[k]?.color||'#94a3b8') }] } });

    const topBatt = [...garage].sort((A,B)=>B.battles-A.battles).slice(0,10);
    upsert('barTopBattles', $('#barTopBattles'), { type:'bar', data:{ labels: topBatt.map(g=> `${g.clsEmoji} ${g.name}`), datasets:[{ label:'Bitvy', data: topBatt.map(g=>g.battles), backgroundColor: topBatt.map(()=>COLORS.battles) }] }, options:{ indexAxis:'y' } });

    renderGarage(garage);
  }

  function renderGarage(list){
    const grid = $('#garageGrid'); grid.innerHTML='';
    list.forEach(g=>{
      const card=$c('div','card overflow-hidden');
      const img=$c('img','w-full h-36 object-contain bg-slate-800'); img.src=g.img; img.alt=g.name; card.appendChild(img);
      const box=$c('div','p-4 space-y-2');
      const head=$c('div','flex items-center justify-between');
      const badge = `<span class="badge" style="color:${g.clsColor};border-color:${g.clsColor}">${g.clsEmoji} ${g.cls||''}</span>`;
      head.innerHTML = `<div><div class='font-semibold'>${g.name}</div><div class='text-xs text-slate-400'>Tier ${g.tier} ‚Ä¢ ${g.nation?.toUpperCase()} ‚Ä¢ ${badge}</div></div><div class='text-right text-sm'>Bitvy: <b>${fmt(g.battles)}</b><div class='text-xs text-slate-400'>V√Ωhry: ${fmt(g.wins)} ‚Ä¢ Prohry: ${fmt(g.losses)}</div></div>`;
      const grid2=$c('div','grid grid-cols-2 gap-3 text-sm');
      grid2.innerHTML = `<div><div class='text-xs text-slate-400'>DMG celkem</div><div class='font-semibold'>${fmt(g.dmg)}</div></div><div><div class='text-xs text-slate-400'>Pr≈Øm. DMG</div><div class='font-semibold'>${fmt(g.avg)}</div></div><div><div class='text-xs text-slate-400'>Zniƒçen√©</div><div class='font-semibold'>${fmt(g.frags)}</div></div><div><div class='text-xs text-slate-400'>Winrate</div><div class='font-semibold'>${g.battles?pct(g.wins/g.battles):'-'}</div></div>`;
      const btn=$c('button','btn btn-emerald w-full'); btn.textContent='Detail tanku'; btn.onclick=()=> openTank(g);
      box.append(head,grid2,btn); card.appendChild(box); grid.appendChild(card);
    });
  }

  let CH_TANK_PIE=null, CH_TANK_BAR=null;
  function openTank(g){
    $('#tankTitle').textContent=g.name; $('#tankMeta').innerHTML=`Tier ${g.tier} ‚Ä¢ ${g.nation?.toUpperCase()} ‚Ä¢ <span class='badge' style='color:${g.clsColor};border-color:${g.clsColor}'>${g.clsEmoji} ${g.cls||''}</span>`; $('#tankImage').src=g.img;
    $('#tdBattles').textContent=fmt(g.battles); $('#tdWins').textContent=fmt(g.wins); $('#tdLosses').textContent=fmt(g.losses); $('#tdAvg').textContent=fmt(g.avg); $('#tdDmg').textContent=fmt(g.dmg); $('#tdFrags').textContent=fmt(g.frags);
    if(CH_TANK_PIE){ CH_TANK_PIE.destroy(); CH_TANK_PIE=null; }
    if(CH_TANK_BAR){ CH_TANK_BAR.destroy(); CH_TANK_BAR=null; }
    CH_TANK_PIE = new Chart($('#tankPie'), { type:'doughnut', data:{ labels:['V√Ωhry','Prohry'], datasets:[{ data:[g.wins,g.losses], backgroundColor:[COLORS.win,COLORS.loss] }] } });
    CH_TANK_BAR = new Chart($('#tankBar'), { type:'bar', data:{ labels:['DMG celkem','Pr≈Øm. DMG','Zniƒçen√©'], datasets:[{ data:[g.dmg,g.avg,g.frags], label:'Hodnota' }] }, options:{ indexAxis:'y' } });
    openModal('tankModal');
  }

  // ====== COMPARE ======
  document.getElementById('cmpBtn').addEventListener('click', async ()=>{
    const a=$('#cmpA').value.trim(), b=$('#cmpB').value.trim(), region=$('#region').value; if(!a||!b) return;
    loader.on();
    try{ const [accA,accB]=await Promise.all([searchAccount(a,region), searchAccount(b,region)]); if(!accA||!accB) throw new Error('Hr√°ƒç A nebo B nenalezen'); const [infoA,infoB]=await Promise.all([accountInfo(accA.account_id,region), accountInfo(accB.account_id,region)]); renderCompare({acc:accA,info:infoA},{acc:accB,info:infoB}); }catch(e){ alert(e.message||String(e)); } finally{ loader.off(); }
  });
  function renderCompare(A,B){ const sA=A.info?.statistics?.all||{}; const sB=B.info?.statistics?.all||{}; const vA={ battles:sA.battles||0, wins:sA.wins||0, losses:(sA.battles||0)-(sA.wins||0)-(sA.draws||0), dmg:sA.damage_dealt||0 }; const vB={ battles:sB.battles||0, wins:sB.wins||0, losses:(sB.battles||0)-(sB.wins||0)-(sB.draws||0), dmg:sB.damage_dealt||0 }; $('#cmpResult').classList.remove('hidden'); $('#cmpNameA').textContent='üÖ∞Ô∏è '+A.acc.nickname; $('#cmpNameB').textContent='üÖ±Ô∏è '+B.acc.nickname; $('#cmpKpiA').innerHTML=`<div><div class='text-xs text-slate-400'>Bitvy</div><div class='font-semibold'>${fmt(vA.battles)}</div></div><div><div class='text-xs text-slate-400'>Winrate</div><div class='font-semibold'>${vA.battles?pct(vA.wins/vA.battles):'-'}</div></div><div><div class='text-xs text-slate-400'>V√Ωhry</div><div class='font-semibold'>${fmt(vA.wins)}</div></div><div><div class='text-xs text-slate-400'>DMG</div><div class='font-semibold'>${fmt(vA.dmg)}</div></div>`; $('#cmpKpiB').innerHTML=`<div><div class='text-xs text-slate-400'>Bitvy</div><div class='font-semibold'>${fmt(vB.battles)}</div></div><div><div class='text-xs text-slate-400'>Winrate</div><div class='font-semibold'>${vB.battles?pct(vB.wins/vB.battles):'-'}</div></div><div><div class='text-xs text-slate-400'>V√Ωhry</div><div class='font-semibold'>${fmt(vB.wins)}</div></div><div><div class='text-xs text-slate-400'>DMG</div><div class='font-semibold'>${fmt(vB.dmg)}</div></div>`; upsert('cmp', $('#cmpChart'), { type:'bar', data:{ labels:['Bitvy','V√Ωhry','Prohry','Celkov√Ω DMG'], datasets:[{ label:A.acc.nickname, data:[vA.battles,vA.wins,vA.losses,vA.dmg], backgroundColor:COLORS.A },{ label:B.acc.nickname, data:[vB.battles,vB.wins,vB.losses,vB.dmg], backgroundColor:COLORS.B }] } }); }

  // ====== CLANS ======
  document.getElementById('clanBtn').addEventListener('click', async ()=>{
    const q=$('#clanInput').value.trim(), region=$('#region').value; if(!q) return; loader.on(); try{ const cl=await clanSearch(q,region); if(!cl) throw new Error('Klan nenalezen'); const info=await clanInfo(cl.clan_id,region); renderClan(info,region); }catch(e){ alert(e.message||String(e)); } finally{ loader.off(); }
  });
  async function renderClan(c, region){ const box=$('#clanResult'); box.classList.remove('hidden'); box.innerHTML=''; const head=$c('div','flex items-center justify-between'); head.innerHTML=`<div><div class='text-xl font-semibold'>üè∞ [${c.tag}] ${c.name}</div><div class='text-slate-400 text-sm'>Zalo≈æen: ${new Date(c.created_at*1000).toLocaleDateString('cs-CZ')} ‚Ä¢ ƒålen≈Ø: ${c.members_count}</div></div>`; box.appendChild(head); const tbl=$c('div','overflow-x-auto mt-3'); const table=$c('table','w-full text-sm'); table.innerHTML=`<thead class='text-left text-slate-400'><tr><th class='py-2 pr-4'>Hr√°ƒç</th><th class='py-2 pr-4'>Role</th><th class='py-2 pr-4'>P≈ôid√°n</th><th class='py-2'>Winrate (vzorek)</th></tr></thead><tbody></tbody>`; tbl.appendChild(table); box.appendChild(tbl); const tbody=table.querySelector('tbody'); const sample=c.members.slice(0,20); let wrSum=0, wrCnt=0; for(const m of sample){ try{ const info=await accountInfo(m.account_id,region); const s=info?.statistics?.all||{}; const wr=s.battles? s.wins/s.battles: 0; if(s.battles){ wrSum+=wr; wrCnt++; } const tr=$c('tr','border-t border-white/10'); tr.innerHTML=`<td class='py-2 pr-4'>${info.nickname||m.account_name}</td><td class='py-2 pr-4'>${m.role_i18n||m.role}</td><td class='py-2 pr-4'>${new Date(m.joined_at*1000).toLocaleDateString('cs-CZ')}</td><td class='py-2'>${s.battles?pct(wr):'‚Äî'}</td>`; tbody.appendChild(tr); }catch{} } const avg=wrCnt? pct(wrSum/wrCnt):'‚Äî'; const note=$c('div','mt-2 text-slate-300'); note.textContent=`üìä Pr≈Ømƒõrn√Ω winrate (vzorek ${wrCnt} hr√°ƒç≈Ø z 20): ${avg}`; box.appendChild(note); }

  // ====== LEADERBOARD ======
  document.getElementById('lbBtn').addEventListener('click', async ()=>{
    const names=$('#lbInput').value.split(',').map(s=>s.trim()).filter(Boolean); const metric=$('#lbMetric').value; const region=$('#region').value; if(!names.length) return; loader.on(); try{ const accs=await Promise.all(names.map(n=>searchAccount(n,region))); const valid=accs.filter(Boolean); const infos=await Promise.all(valid.map(a=>accountInfo(a.account_id, region))); const rows=valid.map((a,i)=>{ const s=infos[i]?.statistics?.all||{}; const wr=s.battles? s.wins/s.battles:0; const avg=s.battles? Math.round((s.damage_dealt||0)/s.battles):0; return { nick:a.nickname, battles:s.battles||0, wins:s.wins||0, dmg:s.damage_dealt||0, wr, avg }; }); const sorted=rows.sort((A,B)=> metric==='wr'? (B.wr-A.wr) : metric==='battles'? (B.battles-A.battles) : metric==='dmg'? (B.dmg-A.dmg) : (B.avg-A.avg)); renderLeaderboard(sorted, metric); }catch(e){ alert(e.message||String(e)); } finally{ loader.off(); }
  });
  let CH_LB=null; function renderLeaderboard(rows, metric){ $('#lbResult').classList.remove('hidden'); const tbl=$('#lbTable'); tbl.innerHTML=`<thead class='text-left text-slate-400'><tr><th class='py-2 pr-4'>#</th><th class='py-2 pr-4'>Hr√°ƒç</th><th class='py-2 pr-4'>Bitvy</th><th class='py-2 pr-4'>V√Ωhry</th><th class='py-2 pr-4'>Winrate</th><th class='py-2 pr-4'>Celkov√Ω DMG</th><th class='py-2'>Pr≈Øm. DMG</th></tr></thead><tbody></tbody>`; const tbody=tbl.querySelector('tbody'); rows.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.className='border-t border-white/10'; tr.innerHTML=`<td class='py-2 pr-4'>${i+1}</td><td class='py-2 pr-4'>${r.nick}</td><td class='py-2 pr-4'>${fmt(r.battles)}</td><td class='py-2 pr-4'>${fmt(r.wins)}</td><td class='py-2 pr-4'>${r.battles?pct(r.wr):'‚Äî'}</td><td class='py-2 pr-4'>${fmt(r.dmg)}</td><td class='py-2'>${fmt(r.avg)}</td>`; tbody.appendChild(tr); }); const labels=rows.map(r=>r.nick); const vals=rows.map(r=> metric==='wr'? (r.wr*100).toFixed(2) : metric==='battles'? r.battles : metric==='dmg'? r.dmg : r.avg); const labelName=metric==='wr'? 'Winrate %' : metric==='battles'? 'Bitvy' : metric==='dmg'? 'DMG' : 'Pr≈Øm. DMG'; if(CH_LB){ CH_LB.destroy(); CH_LB=null; } CH_LB=new Chart($('#lbChart'), { type:'bar', data:{ labels, datasets:[{ label:labelName, data:vals }] }, options:{ indexAxis:'y' } }); }
</script>
</body>
</html>
