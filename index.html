<!DOCTYPE html>
<html lang="cs" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>WoT Stats – stable v5 (mobile)</title>

  <!-- Fonts & libs -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com" defer></script>
  <script>try{tailwind.config={darkMode:'class'};}catch(e){}</script>

  <!-- Ikony + grafy -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>

  <link rel="stylesheet" href="style.css">
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-900 via-slate-950 to-black text-slate-100">
  <div id="loader"><div class="spinner"></div></div>

  <header class="sticky top-0 z-40 backdrop-blur bg-slate-900/80 border-b border-white/5">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="chip">beta</span>
        <h1 class="text-xl font-bold">WoT Stats</h1>
      </div>
      <div class="flex items-center gap-2">
        <select id="region" class="bg-slate-800/70 border border-white/10 rounded-xl px-3 py-2">
          <option value="eu" selected>EU</option>
          <option value="na">NA</option>
          <option value="asia">ASIA</option>
          <option value="ru">RU</option>
        </select>
        <button id="toggleTheme" class="btn btn-purple" title="Přepnout téma">
          <span data-lucide="sun"></span><span class="hidden md:inline">Téma</span>
        </button>
        <button id="openInfo" class="btn btn-emerald">
          <span data-lucide="info"></span><span class="hidden md:inline">Info & Novinky</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Info modal -->
  <div id="infoModal" class="modal">
    <div class="modal-backdrop" onclick="closeModal('infoModal')"></div>
    <div class="modal-body">
      <div class="card p-6">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">O stránce</h3>
          <button class="btn" onclick="closeModal('infoModal')">Zavřít</button>
        </div>

        <p class="text-slate-300 mb-4">
          Neoficiální přehled a vizualizace statistik <b>World of Tanks</b> nad veřejným WG API.
          Vše běží v prohlížeči, nic se neukládá (mimo volitelného lokálního snapshotu pro „Poslední bitvy“).
        </p>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <h4 class="font-semibold mb-2">Co umí</h4>
            <ul class="list-disc ml-6 space-y-1 text-slate-300">
              <li>Hledání hráče • KPI (bitvy, výhry, WR, DMG…)</li>
              <li>Garáž • karty tanků + <i>Detail tanku</i> s mini grafy</li>
              <li>Grafy • Výhry vs Prohry, Top 10 DMG…</li>
              <li>Porovnání hráčů (A vs B)</li>
              <li>Žebříček hráčů (seznam přezdívek + metrika)</li>
              <li>Klanové statistiky (hlavička + WR vzorek členů)</li>
              <li>Poslední bitvy • rozdíl od uloženého snapshotu</li>
              <li>Tmavý režim, animace načítání</li>
            </ul>
          </div>
          <div>
            <h4 class="font-semibold mb-2">Jak používat</h4>
            <ol class="list-decimal ml-6 space-y-1 text-slate-300">
              <li>Zadej přezdívku → <b>Hledat hráče</b> (nebo do URL <code>?player=Nick</code>).</li>
              <li>V <b>Garáži</b> otevři <i>Detail tanku</i>.</li>
              <li>Pro <b>Poslední bitvy</b>: nejdřív <b>Uložit snapshot</b>, po hraní <b>Vyhodnotit</b>.</li>
              <li>Porovnání: vyplň A a B → <b>Porovnat</b>.</li>
              <li>Žebříček: vlož nicky oddělené čárkou a zvol metriku.</li>
            </ol>
          </div>
        </div>

        <h4 class="font-semibold mt-4 mb-2">Poznámky</h4>
        <ul class="list-disc ml-6 space-y-1 text-slate-300">
          <li>Data z veřejného WG API (EU/NA/ASIA/RU). Historie „posledních bitev“ není v API, sekce je spočtena jako rozdíl.</li>
          <li>Projekt není oficiálně spojen s Wargamingem.</li>
        </ul>
      </div>
    </div>
  </div>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-8">

    <!-- Hledání hráče -->
    <section class="card p-4">
      <div class="grid gap-3 md:grid-cols-[1fr_auto] items-center">
        <input id="playerInput" class="bg-slate-800/70 border border-white/10 rounded-xl px-3 py-2" placeholder="Hledat hráče (nickname)…" />
        <button id="searchBtn" class="btn btn-primary"><span data-lucide="search"></span>Hledat hráče</button>
      </div>
      <p id="errorBox" class="mt-2 text-red-400 hidden"></p>
      <p class="mt-2 text-slate-400 text-sm">Tip: Enter spustí hledání. Lze také <code>?player=nickname</code>.</p>
    </section>

    <!-- Porovnání hráčů -->
    <section class="card p-4 space-y-3">
      <h3 class="font-semibold">Porovnání hráčů</h3>
      <div class="grid gap-3 md:grid-cols-[1fr_1fr_auto] items-center">
        <input id="cmpA" class="bg-slate-800/70 border border-white/10 rounded-xl px-3 py-2" placeholder="Hráč A">
        <input id="cmpB" class="bg-slate-800/70 border border-white/10 rounded-xl px-3 py-2" placeholder="Hráč B">
        <button id="cmpBtn" class="btn btn-primary">Porovnat</button>
      </div>
      <div id="cmpResult" class="hidden">
        <div class="grid md:grid-cols-2 gap-4">
          <div class="card p-4"><h4 id="cmpNameA" class="font-semibold mb-2">A</h4><div id="cmpKpiA" class="text-sm space-y-1"></div></div>
          <div class="card p-4"><h4 id="cmpNameB" class="font-semibold mb-2">B</h4><div id="cmpKpiB" class="text-sm space-y-1"></div></div>
        </div>
        <div class="card p-4 mt-3">
          <h4 class="font-semibold mb-2">Porovnání KPI</h4>
          <div class="chart-box"><canvas id="cmpChart"></canvas></div>
        </div>
      </div>
    </section>

    <!-- Klanové statistiky -->
    <section class="card p-4 space-y-3">
      <h3 class="font-semibold">Klanové statistiky</h3>
      <div class="grid gap-3 md:grid-cols-[1fr_auto] items-center">
        <input id="clanQuery" class="bg-slate-800/70 border border-white/10 rounded-xl px-3 py-2" placeholder="Hledat klan (tag nebo název)…">
        <button id="clanBtn" class="btn btn-emerald">Najít klan</button>
      </div>
      <div id="clanResult" class="hidden">
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <div><h4 id="clanName" class="font-semibold">—</h4><div id="clanMeta" class="text-xs text-slate-400">—</div></div>
            <div class="text-right"><div class="text-xs text-slate-400">Členů</div><div id="clanMembers" class="text-lg font-semibold">—</div></div>
          </div>
        </div>
        <div class="card p-4">
          <h4 class="font-semibold mb-2">Vzorek členů (winrate)</h4>
          <div class="chart-box"><canvas id="clanChart"></canvas></div>
        </div>
      </div>
    </section>

    <!-- Žebříček hráčů -->
    <section class="card p-4 space-y-3">
      <h3 class="font-semibold">Žebříček hráčů</h3>
      <div class="grid gap-3 md:grid-cols-[1fr_auto_auto] items-center">
        <input id="lbNames" class="bg-slate-800/70 border border-white/10 rounded-xl px-3 py-2" placeholder="Nicky oddělené čárkou, např.: LaysenCZECH, PlayerTwo, PlayerThree">
        <select id="lbMetric" class="bg-slate-800/70 border border-white/10 rounded-xl px-3 py-2">
          <option value="wr">Winrate</option>
          <option value="battles">Bitvy</option>
          <option value="dmg">DMG celkem</option>
          <option value="avg">Prům. DMG</option>
        </select>
        <button id="lbBtn" class="btn btn-primary">Načíst žebříček</button>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div class="overflow-x-auto"><table id="lbTable" class="w-full text-sm"></table></div>
        <div class="card p-4">
          <h4 class="font-semibold mb-2">Graf žebříčku</h4>
          <div class="chart-box"><canvas id="lbChart"></canvas></div>
        </div>
      </div>
    </section>

    <!-- Výstup hráče -->
    <section id="playerSection" class="hidden space-y-6">
      <div class="flex flex-wrap items-end justify-between gap-4">
        <div>
          <h2 id="playerName" class="text-2xl font-bold">—</h2>
          <div class="text-slate-400 text-sm">
            Region: <span id="playerRegion">EU</span> • ID: <span id="playerId">—</span> • Poslední bitva: <span id="lastBattle">—</span>
          </div>
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-4">
        <div class="card p-4"><div class="text-xs text-slate-400">Bitvy</div><div id="kpiBattles" class="text-xl font-semibold">-</div></div>
        <div class="card p-4"><div class="text-xs text-slate-400">Výhry</div><div id="kpiWins" class="text-xl font-semibold">-</div></div>
        <div class="card p-4"><div class="text-xs text-slate-400">Prohry</div><div id="kpiLosses" class="text-xl font-semibold">-</div></div>
        <div class="card p-4"><div class="text-xs text-slate-400">Winrate</div><div id="kpiWR" class="text-xl font-semibold">-</div></div>
        <div class="card p-4"><div class="text-xs text-slate-400">DMG celkem</div><div id="kpiDmg" class="text-xl font-semibold">-</div></div>
        <div class="card p-4"><div class="text-xs text-slate-400">Průměr DMG / bitvu</div><div id="kpiAvg" class="text-xl font-semibold">-</div></div>
      </div>

      <div class="grid md:grid-cols-3 gap-4">
        <div class="card p-4"><h3 class="font-semibold mb-2">Výhry vs Prohry</h3><div class="chart-box"><canvas id="barWinLoss"></canvas></div></div>
        <div class="card p-4"><h3 class="font-semibold mb-2">Podíl výher/proher</h3><div class="chart-box"><canvas id="pieWinLoss"></canvas></div></div>
        <div class="card p-4"><h3 class="font-semibold mb-2">Top 10 tanků podle DMG</h3><div class="chart-box"><canvas id="barTopDmg"></canvas></div></div>
      </div>

      <!-- POSLEDNÍ BITVY / AKTIVITA -->
      <section class="card p-4">
        <div class="flex items-center justify-between mb-2 sticky top-[64px] z-30 bg-slate-900/80 backdrop-blur rounded-lg px-2 py-2">
          <h3 class="font-semibold">Poslední bitvy / aktivita (od uloženého snapshotu)</h3>
          <div class="flex items-center gap-2 text-sm">
            <button id="snapCreateBtn" class="btn btn-emerald" title="Uloží aktuální stav jako výchozí">💾</button>
            <button id="snapComputeBtn" class="btn btn-primary" title="Spočítá změny od snapshotu">📈</button>
            <button id="snapClearBtn" class="btn" title="Smazat uložený snapshot">🗑️</button>
          </div>
        </div>
        <div class="text-slate-400 text-sm mb-2">
          Snapshot je uložen <b>lokálně</b> v tomto prohlížeči. Nejprve ho ulož (před hraním), po hraní klikni na „Vyhodnotit“.
        </div>
        <div id="snapInfo" class="text-slate-300 text-sm mb-3">—</div>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="overflow-x-auto"><table id="recentTable" class="w-full text-sm"></table></div>
          <div class="card p-4">
            <h4 class="font-semibold mb-2">Souhrn podle tanků</h4>
            <div class="chart-box"><canvas id="recentChart"></canvas></div>
          </div>
        </div>
      </section>

      <!-- Garáž -->
      <section class="space-y-3">
        <h3 class="text-xl font-semibold">Garáž tanků</h3>
        <div id="garageGrid" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
      </section>
    </section>
  </main>

  <!-- Tank modal -->
  <div id="tankModal" class="modal">
    <div class="modal-backdrop" onclick="closeModal('tankModal')"></div>
    <div class="modal-body tank-modal">
      <div class="card p-0 overflow-hidden">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
          <div>
            <h4 id="tankTitle" class="font-semibold">Tank</h4>
            <div id="tankMeta" class="text-xs text-slate-400">—</div>
          </div>
          <button class="btn" onclick="closeModal('tankModal')">Zavřít</button>
        </div>

        <div class="p-4 grid md:grid-cols-2 gap-4">
          <div>
            <img id="tankImage" class="left-img w-full h-48 object-contain" />
            <div class="mt-3 grid grid-cols-2 gap-2">
              <div class="pill-kpi"><div class="label">Bitvy</div><div id="tkBattles" class="value">-</div></div>
              <div class="pill-kpi"><div class="label">Výhry</div><div id="tkWins" class="value">-</div></div>
              <div class="pill-kpi"><div class="label">Prohry</div><div id="tkLosses" class="value">-</div></div>
              <div class="pill-kpi"><div class="label">DMG celkem</div><div id="tkDmg" class="value">-</div></div>
              <div class="pill-kpi"><div class="label">Prům. DMG</div><div id="tkAvg" class="value">-</div></div>
              <div class="pill-kpi"><div class="label">Zničené</div><div id="tkFrags" class="value">-</div></div>
            </div>
          </div>

          <div>
            <h5 class="font-semibold mb-2">Mini grafy</h5>
            <div class="flex items-center gap-3 mb-2">
              <span class="pill"><span class="mini" style="background:#10b981"></span>Výhry</span>
              <span class="pill"><span class="mini" style="background:#ef4444"></span>Prohry</span>
            </div>
            <div class="chart-box"><canvas id="tankPie"></canvas></div>
            <div class="mt-4 chart-box"><canvas id="tankBar"></canvas></div>
          </div>
        </div>

      </div>
    </div>
  </div>

<!-- ====== APP SCRIPT ====== -->
<script>
'use strict';

// ====== CONFIG ======
const WG_APP_ID = "028df7d564e4447b29c6c3ee894142cb";
const REGIONS = {
  eu:'https://api.worldoftanks.eu',
  na:'https://api.worldoftanks.com',
  asia:'https://api.worldoftanks.asia',
  ru:'https://api.worldoftanks.ru'
};
const COLORS = { win:'#10b981', loss:'#ef4444', dmg:'#60a5fa', battles:'#94a3b8' };

// ====== UTILS ======
const $ = (s)=> document.querySelector(s);
const $c = (t,cls)=>{ const e=document.createElement(t); if(cls) e.className=cls; return e; };
function fmt(n){ return (n??0).toLocaleString('cs-CZ'); }
function pct(n){ return ((n||0)*100).toFixed(2)+'%'; }
function ts(t){ return t? new Date(t*1000).toLocaleString('cs-CZ'):'—'; }
const loader = { on(){ $('#loader').classList.add('show'); }, off(){ $('#loader').classList.remove('show'); } };

// Modály
function openModal(id){ const el=document.getElementById(id); if(el){ el.classList.add('open'); document.body.style.overflow='hidden'; } }
function closeModal(id){ const el=document.getElementById(id); if(el){ el.classList.remove('open'); document.body.style.overflow=''; } }

// Chart.js dark defaults po načtení knihovny
document.addEventListener('DOMContentLoaded', ()=>{
  if(window.Chart){
    Chart.defaults.color = '#e2e8f0';
    Chart.defaults.borderColor = 'rgba(148,163,184,.25)';
    Chart.defaults.font = { size: 13 };
    if(Chart.defaults.plugins && Chart.defaults.plugins.legend && Chart.defaults.plugins.legend.labels){
      Chart.defaults.plugins.legend.labels.color = '#e2e8f0';
    }
  }
});

// ====== API ======
async function getJSON(url){
  const r=await fetch(url);
  if(!r.ok) throw new Error('HTTP '+r.status);
  const j=await r.json();
  if(j.status!=='ok') throw new Error((j.error && j.error.message) ? j.error.message : 'Chyba API');
  return j.data;
}
async function searchAccount(nick, region){
  const u=`${REGIONS[region]}/wot/account/list/?application_id=${WG_APP_ID}&search=${encodeURIComponent(nick)}&limit=1`;
  const d=await getJSON(u); return (d && d[0]) ? d[0] : null;
}
async function accountInfo(id, region){
  const u=`${REGIONS[region]}/wot/account/info/?application_id=${WG_APP_ID}&account_id=${id}`;
  const d=await getJSON(u); return d ? d[id] : null;
}
async function tanksStats(id, region){
  const u=`${REGIONS[region]}/wot/tanks/stats/?application_id=${WG_APP_ID}&account_id=${id}`;
  const d=await getJSON(u); return (d && d[id]) ? d[id] : [];
}
async function vehiclesByIds(ids, region){
  const out={};
  const chunks=(a,n)=> a.length ? [a.slice(0,n), ...chunks(a.slice(n),n)] : [];
  for(const part of chunks(ids, 90)){
    const u=`${REGIONS[region]}/wot/encyclopedia/vehicles/?application_id=${WG_APP_ID}&tank_id=${part.join(',')}`;
    const data = await getJSON(u);
    Object.assign(out, data);
  }
  return out;
}

// ====== COMMON ======
function kpiFromInfo(info){
  const s=(info && info.statistics && info.statistics.all) ? info.statistics.all : {};
  const battles=s.battles||0;
  const wins=s.wins||0;
  const draws=s.draws||0;
  const losses=Math.max(0,battles-wins-draws);
  const dmg=s.damage_dealt||0;
  const avg=battles?Math.round(dmg/battles):0;
  const wr=battles?wins/battles:0;
  return { battles, wins, losses, dmg, avg, wr };
}
function classBadge(cls){
  const c=(cls||'').toLowerCase();
  if(c==='heavytank') return 'badge-ht';
  if(c==='mediumtank') return 'badge-mt';
  if(c==='lighttank') return 'badge-lt';
  if(c==='at-spg' || c==='tank_destroyer' || c==='td') return 'badge-td';
  if(c==='spg' || c==='self_propelled_gun') return 'badge-spg';
  return '';
}

// ====== EVENTS ======
document.getElementById('toggleTheme').addEventListener('click', ()=> document.documentElement.classList.toggle('dark'));
document.getElementById('openInfo').addEventListener('click', ()=> openModal('infoModal'));

document.getElementById('playerInput').addEventListener('keydown', (e)=>{
  if(e.key==='Enter'){ e.preventDefault(); document.getElementById('searchBtn').click(); }
});
['cmpA','cmpB'].forEach(id=>{
  const el=document.getElementById(id);
  el.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); document.getElementById('cmpBtn').click(); }});
});
document.getElementById('clanQuery').addEventListener('keydown', e=>{
  if(e.key==='Enter'){ e.preventDefault(); document.getElementById('clanBtn').click(); }
});
document.getElementById('lbNames').addEventListener('keydown', e=>{
  if(e.key==='Enter'){ e.preventDefault(); document.getElementById('lbBtn').click(); }
});

document.getElementById('searchBtn').addEventListener('click', async ()=>{
  const nick = $('#playerInput').value.trim();
  const region = $('#region').value;
  if(!nick) return;

  $('#errorBox').classList.add('hidden'); loader.on();
  try{
    const acc = await searchAccount(nick, region);
    if(!acc) throw new Error('Hráč nenalezen');

    const [info, tstats] = await Promise.all([
      accountInfo(acc.account_id, region),
      tanksStats(acc.account_id, region)
    ]);

    const ids = [...new Set(tstats.map(t=>t.tank_id))];
    const vmap = await vehiclesByIds(ids, region);

    renderPlayer(acc, info, tstats, vmap, region);
  }catch(e){
    $('#errorBox').textContent = e.message || String(e);
    $('#errorBox').classList.remove('hidden');
  }finally{
    loader.off();
  }
});

// Porovnání hráčů
document.getElementById('cmpBtn').addEventListener('click', async ()=>{
  const a=$('#cmpA').value.trim(); const b=$('#cmpB').value.trim(); const region=$('#region').value;
  if(!a||!b) return;
  loader.on();
  try{
    const [accA, accB] = await Promise.all([searchAccount(a,region), searchAccount(b,region)]);
    if(!accA||!accB) throw new Error('Hráč A nebo B nenalezen.');
    const [infoA, infoB] = await Promise.all([accountInfo(accA.account_id,region), accountInfo(accB.account_id,region)]);
    const kA = kpiFromInfo(infoA); const kB = kpiFromInfo(infoB);

    $('#cmpResult').classList.remove('hidden');
    $('#cmpNameA').textContent = accA.nickname;
    $('#cmpNameB').textContent = accB.nickname;
    $('#cmpKpiA').innerHTML = `Bitvy: <b>${fmt(kA.battles)}</b><br>Výhry: <b>${fmt(kA.wins)}</b> (${pct(kA.wr)})<br>DMG: <b>${fmt(kA.dmg)}</b> • Avg: <b>${fmt(kA.avg)}</b>`;
    $('#cmpKpiB').innerHTML = `Bitvy: <b>${fmt(kB.battles)}</b><br>Výhry: <b>${fmt(kB.wins)}</b> (${pct(kB.wr)})<br>DMG: <b>${fmt(kB.dmg)}</b> • Avg: <b>${fmt(kB.avg)}</b>`;

    if(CHARTS.cmp){ CHARTS.cmp.destroy(); }
    CHARTS.cmp = new Chart(document.getElementById('cmpChart'),{
      type:'bar',
      data:{
        labels:['Bitvy','Výhry','Prohry','DMG','Avg DMG','Winrate %'],
        datasets:[
          {label:accA.nickname, data:[kA.battles,kA.wins,kA.losses,kA.dmg,kA.avg,(kA.wr*100)], backgroundColor:'#22c55e'},
          {label:accB.nickname, data:[kB.battles,kB.wins,kB.losses,kB.dmg,kB.avg,(kB.wr*100)], backgroundColor:'#3b82f6'}
        ]
      },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'top'}} }
    });
  }catch(e){ alert(e.message||e); }
  finally{ loader.off(); }
});

// Klany
async function clanSearch(query, region){
  const u = `${REGIONS[region]}/wot/clans/list/?application_id=${WG_APP_ID}&search=${encodeURIComponent(query)}&limit=1`;
  const d = await getJSON(u);
  return (d && d[0]) ? d[0] : null;
}
async function clanInfo(clan_id, region){
  const u = `${REGIONS[region]}/wot/clans/info/?application_id=${WG_APP_ID}&clan_id=${clan_id}&extra=members`;
  const d = await getJSON(u);
  return d ? d[clan_id] : null;
}
document.getElementById('clanBtn').addEventListener('click', async ()=>{
  const q=$('#clanQuery').value.trim(); const region=$('#region').value;
  if(!q) return;
  loader.on();
  try{
    const clan = await clanSearch(q, region);
    if(!clan) throw new Error('Klan nenalezen.');
    const ci = await clanInfo(clan.clan_id, region);

    $('#clanResult').classList.remove('hidden');
    $('#clanName').textContent = `[${ci.tag}] ${ci.name}`;
    $('#clanMeta').textContent = `Clan ID: ${ci.clan_id} • Region: ${region.toUpperCase()}`;
    $('#clanMembers').textContent = ci.members_count || (ci.members ? ci.members.length : '—');

    const ids = (ci.members||[]).slice(0,25).map(m=>m.account_id);
    if(ids.length){
      const u = `${REGIONS[region]}/wot/account/info/?application_id=${WG_APP_ID}&account_id=${ids.join(',')}`;
      const data = await getJSON(u);
      const rows = ids.map(id=>{
        const inf=data[id]; const k=kpiFromInfo(inf);
        return { name: (inf && inf.nickname) ? inf.nickname : String(id), wr: (k.wr*100) };
      }).sort((A,B)=>B.wr-A.wr);

      if(CHARTS.clan){ CHARTS.clan.destroy(); }
      CHARTS.clan = new Chart(document.getElementById('clanChart'),{
        type:'bar',
        data:{ labels: rows.map(r=>r.name), datasets:[{ label:'Winrate %', data: rows.map(r=>r.wr), backgroundColor:'#06b6d4' }] },
        options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
      });
    }
  }catch(e){ alert(e.message||e); }
  finally{ loader.off(); }
});

// Žebříček
document.getElementById('lbBtn').addEventListener('click', async ()=>{
  const names = $('#lbNames').value.split(',').map(s=>s.trim()).filter(Boolean);
  const metric = $('#lbMetric').value; const region=$('#region').value;
  if(!names.length) return;

  loader.on();
  try{
    const accs = await Promise.all(names.map(n=>searchAccount(n,region)));
    const valid = accs.filter(Boolean);
    if(!valid.length) throw new Error('Žádný hráč nenalezen.');
    const ids = valid.map(a=>a.account_id);
    const u = `${REGIONS[region]}/wot/account/info/?application_id=${WG_APP_ID}&account_id=${ids.join(',')}`;
    const data = await getJSON(u);

    const rows = valid.map(a=>{
      const k = kpiFromInfo(data[a.account_id]);
      const val = (metric==='wr') ? (k.wr*100) : (metric==='battles') ? k.battles : (metric==='dmg') ? k.dmg : k.avg;
      return { name:a.nickname, value: val, k };
    }).sort((A,B)=>B.value-A.value);

    const tbl = $('#lbTable');
    const headLbl = (metric==='wr') ? 'Winrate %' : (metric==='battles') ? 'Bitvy' : (metric==='dmg') ? 'DMG celkem' : 'Prům. DMG';
    tbl.innerHTML = `<thead class='text-left text-slate-400'><tr><th class='py-2 pr-4'>#</th><th class='py-2 pr-4'>Hráč</th><th class='py-2 pr-4'>${headLbl}</th><th class='py-2'>Bitvy</th></tr></thead><tbody></tbody>`;
    const tb = tbl.querySelector('tbody');
    rows.forEach((r,i)=>{
      const tr=document.createElement('tr'); tr.className='border-t border-white/10';
      tr.innerHTML = `<td class='py-2 pr-4'>${i+1}</td><td class='py-2 pr-4'>${r.name}</td><td class='py-2 pr-4'>${metric==='wr'? r.value.toFixed(2)+'%' : fmt(r.value)}</td><td class='py-2'>${fmt(r.k.battles)}</td>`;
      tb.appendChild(tr);
    });

    if(CHARTS.lb){ CHARTS.lb.destroy(); }
    CHARTS.lb = new Chart(document.getElementById('lbChart'),{
      type:'bar',
      data:{ labels: rows.map(r=>r.name), datasets:[{ label: headLbl, data: rows.map(r=>r.value), backgroundColor:'#8b5cf6' }] },
      options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
    });
  }catch(e){ alert(e.message||e); }
  finally{ loader.off(); }
});

// ====== RENDER PLAYER ======
let CHARTS={};
function upsert(ref, canvasEl, cfg){
  if(CHARTS[ref]){ CHARTS[ref].data=cfg.data; CHARTS[ref].options=cfg.options||{}; CHARTS[ref].update(); }
  else { CHARTS[ref]=new Chart(canvasEl, cfg); }
}

function renderPlayer(acc, info, tstats, vmap, region){
  const s=(info && info.statistics && info.statistics.all) ? info.statistics.all : {};
  const battles=s.battles||0;
  const wins=s.wins||0;
  const draws=s.draws||0;
  const losses=Math.max(0,battles-wins-draws);
  const dmg=s.damage_dealt||0;
  const avg=battles?Math.round(dmg/battles):0;
  const wr=battles?wins/battles:0;

  $('#playerSection').classList.remove('hidden');
  $('#playerName').textContent = acc.nickname;
  $('#playerRegion').textContent = region.toUpperCase();
  $('#playerId').textContent = acc.account_id;
  $('#lastBattle').textContent = ts(info ? info.last_battle_time : 0);

  $('#kpiBattles').textContent=fmt(battles);
  $('#kpiWins').textContent=fmt(wins);
  $('#kpiLosses').textContent=fmt(losses);
  $('#kpiWR').textContent=pct(wr);
  $('#kpiDmg').textContent=fmt(dmg);
  $('#kpiAvg').textContent=fmt(avg);

  upsert('barWinLoss', document.getElementById('barWinLoss'), {
    type:'bar',
    data:{ labels:['Výhry','Prohry'], datasets:[{ label:'Počet', data:[wins,losses], backgroundColor:[COLORS.win,COLORS.loss] }] },
    options:{ responsive:true, maintainAspectRatio:false }
  });
  upsert('pieWinLoss', document.getElementById('pieWinLoss'), {
    type:'pie',
    data:{ labels:['Výhry','Prohry'], datasets:[{ label:'Podíl', data:[wins,losses], backgroundColor:[COLORS.win,COLORS.loss] }] },
    options:{ responsive:true, maintainAspectRatio:false }
  });

  // Top 10 DMG
  const byDmg = tstats.map(t=>({ id:t.tank_id, dmg:(t.all && t.all.damage_dealt)||0 }))
                      .sort((A,B)=>B.dmg-A.dmg).slice(0,10);
  const labelsTop = byDmg.map(x=> (vmap && vmap[x.id] && vmap[x.id].name) ? vmap[x.id].name : ('Tank '+x.id));
  const dataTop = byDmg.map(x=> x.dmg);
  upsert('barTopDmg', document.getElementById('barTopDmg'), {
    type:'bar',
    data:{ labels:labelsTop, datasets:[{ label:'DMG', data:dataTop, backgroundColor:'#60a5fa' }] },
    options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
  });

  // Garáž
  const garage = tstats.map(t=>{
    const v=(vmap && vmap[t.tank_id]) ? vmap[t.tank_id] : {};
    const a=t.all||{};
    const b=a.battles||0;
    const w=a.wins||0;
    const d=a.damage_dealt||0;
    const av=b?Math.round(d/b):0;
    const fr=a.frags||0;
    return {
      id:t.tank_id, name:(v.name||('Tank '+t.tank_id)),
      tier:(v.tier||'?'), img:(v.images && (v.images.big_icon||v.images.small_icon)) || '',
      cls:(v.type||''), nation:(v.nation||''),
      battles:b, wins:w, losses:Math.max(0,b-w-(a.draws||0)), dmg:d, avg:av, frags:fr
    };
  }).sort((A,B)=>B.battles-A.battles);
  renderGarage(garage);

  setupSnapshotUI(acc.account_id, info, tstats, vmap);
}

function renderGarage(list){
  const grid = $('#garageGrid'); grid.innerHTML='';
  list.forEach(g=>{
    const card=$c('div','card overflow-hidden p-0');
    const img=$c('img','w-full h-40 object-contain bg-slate-800'); img.src=g.img; img.alt=g.name; card.appendChild(img);

    const box=$c('div','p-4 space-y-3');
    const head=$c('div','flex items-center justify-between');
    const clsBadge = `<span class="badge-class ${classBadge(g.cls)}">${g.cls||'—'}</span>`;
    head.innerHTML =
      `<div>
        <div class='font-semibold'>${g.name}</div>
        <div class='text-xs text-slate-400'>Tier ${g.tier} • ${g.nation ? g.nation.toUpperCase() : ''} • ${clsBadge}</div>
      </div>
      <div class='text-right text-sm'>
        Bitvy: <b>${fmt(g.battles)}</b>
        <div class='text-xs text-slate-400'>Výhry: ${fmt(g.wins)} • Prohry: ${fmt(g.losses)}</div>
      </div>`;
    box.append(head);

    const btn=$c('button','btn btn-emerald w-full'); btn.textContent='Detail tanku';
    btn.addEventListener('click', ()=> openTankDetail(g));
    box.append(btn);

    card.appendChild(box);
    grid.appendChild(card);
  });
}

function openTankDetail(t){
  $('#tankTitle').textContent = t.name;
  const clsTxt = (t.cls||'').toString();
  $('#tankMeta').innerHTML = `Tier ${t.tier} • ${t.nation ? t.nation.toUpperCase() : ''} • <span class="badge-class ${classBadge(clsTxt)}">${clsTxt||'—'}</span>`;
  $('#tankImage').src = t.img||'';

  $('#tkBattles').textContent = fmt(t.battles);
  $('#tkWins').textContent    = fmt(t.wins);
  $('#tkLosses').textContent  = fmt(t.losses);
  $('#tkDmg').textContent     = fmt(t.dmg);
  $('#tkAvg').textContent     = fmt(t.avg);
  $('#tkFrags').textContent   = fmt(t.frags);

  if(CHARTS.tankPie){ CHARTS.tankPie.destroy(); }
  if(CHARTS.tankBar){ CHARTS.tankBar.destroy(); }

  CHARTS.tankPie = new Chart(document.getElementById('tankPie'), {
    type:'doughnut',
    data:{ labels:['Výhry','Prohry'], datasets:[{ data:[t.wins||0, t.losses||0], backgroundColor:[COLORS.win, COLORS.loss], borderWidth:1 }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, cutout:'60%' }
  });

  CHARTS.tankBar = new Chart(document.getElementById('tankBar'), {
    type:'bar',
    data:{
      labels:['DMG celkem','Prům. DMG','Zničené'],
      datasets:[{ label:'Hodnota', data:[t.dmg||0, t.avg||0, t.frags||0], backgroundColor:'#60a5fa' }]
    },
    options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
  });

  openModal('tankModal');
}

// ====== SNAPSHOT LOGIC ======
function snapKey(id){ return `wot_snap_full_${id}`; }
function makeSnapshotPayload(info, tstats){
  const total = (info && info.statistics && info.statistics.all) ? info.statistics.all : {};
  const byTank = {};
  for(const t of tstats){
    const a=t.all||{};
    byTank[t.tank_id]={
      battles:a.battles||0, wins:a.wins||0, draws:a.draws||0,
      dmg:a.damage_dealt||0, frags:a.frags||0
    };
  }
  return {
    ts: Date.now(),
    total:{
      battles:total.battles||0,
      wins:total.wins||0,
      draws:total.draws||0,
      dmg:total.damage_dealt||0,
      frags:total.frags||0
    },
    byTank: byTank
  };
}
function saveSnapshot(id, info, tstats){
  const payload = makeSnapshotPayload(info, tstats);
  localStorage.setItem(snapKey(id), JSON.stringify(payload));
  return payload;
}
function loadSnapshot(id){
  const raw=localStorage.getItem(snapKey(id));
  return raw? JSON.parse(raw): null;
}
function clearSnapshot(id){ localStorage.removeItem(snapKey(id)); }

function computeDelta(snap, info, tstats, vmap){
  const now = makeSnapshotPayload(info, tstats);
  const deltas = [];
  for(const t of tstats){
    const prev = snap.byTank[t.tank_id]||{battles:0,wins:0,draws:0,dmg:0,frags:0};
    const a=t.all||{};
    const db=(a.battles||0)-prev.battles;
    const dw=(a.wins||0)-prev.wins;
    const ddmg=(a.damage_dealt||0)-prev.dmg;
    const dfr=(a.frags||0)-prev.frags;
    if(db>0 || ddmg>0 || dfr>0){
      const v=(vmap && vmap[t.tank_id]) ? vmap[t.tank_id] : {};
      deltas.push({ name:(v.name||('Tank '+t.tank_id)), battles:db, wins:dw, dmg:ddmg, frags:dfr });
    }
  }
  const tot = {
    battles:(now.total.battles - snap.total.battles),
    wins:(now.total.wins - snap.total.wins),
    dmg:(now.total.dmg - snap.total.dmg),
    frags:(now.total.frags - snap.total.frags)
  };
  return { deltas, tot, since: new Date(snap.ts).toLocaleString('cs-CZ'), until: new Date(now.ts).toLocaleString('cs-CZ') };
}

function setupSnapshotUI(account_id, info, tstats, vmap){
  const existing = loadSnapshot(account_id);
  const infoBox = $('#snapInfo');
  if(existing){
    infoBox.textContent = `Uložený snapshot: ${new Date(existing.ts).toLocaleString('cs-CZ')}. Klikni na „Vyhodnotit“ pro zobrazení poslední aktivity.`;
  } else {
    infoBox.textContent = 'Zatím žádný snapshot. Klikni na „Uložit snapshot“, pak po hraní na „Vyhodnotit“.';
  }

  document.getElementById('snapCreateBtn').onclick = ()=>{
    const s=saveSnapshot(account_id, info, tstats);
    infoBox.textContent = `Snapshot uložen: ${new Date(s.ts).toLocaleString('cs-CZ')}`;
  };
  document.getElementById('snapClearBtn').onclick = ()=>{
    clearSnapshot(account_id);
    infoBox.textContent = 'Snapshot smazán.';
    $('#recentTable').innerHTML='';
    upsert('recent', document.getElementById('recentChart'), { type:'bar',
      data:{ labels:[], datasets:[] },
      options:{ responsive:true, maintainAspectRatio:false }
    });
  };
  document.getElementById('snapComputeBtn').onclick = ()=> computeRecent(account_id, info, tstats, vmap);
}

function computeRecent(account_id, info, tstats, vmap){
  const snap = loadSnapshot(account_id);
  if(!snap){ alert('Nejprve ulož snapshot.'); return; }
  const res = computeDelta(snap, info, tstats, vmap);

  const tbl = $('#recentTable');
  tbl.innerHTML = `
    <thead class='text-left text-slate-400'>
      <tr>
        <th class='py-2 pr-4'>Tank</th>
        <th class='py-2 pr-4'>Bitvy</th>
        <th class='py-2 pr-4'>Výhry</th>
        <th class='py-2 pr-4'>DMG</th>
        <th class='py-2'>Zničené</th>
      </tr>
    </thead>
    <tbody></tbody>`;
  const tbody = tbl.querySelector('tbody');
  res.deltas.sort((A,B)=>B.battles-A.battles).forEach(d=>{
    const tr=document.createElement('tr'); tr.className='border-t border-white/10';
    tr.innerHTML = `<td class='py-2 pr-4'>${d.name}</td>
                    <td class='py-2 pr-4'>${fmt(d.battles)}</td>
                    <td class='py-2 pr-4'>${fmt(d.wins)}</td>
                    <td class='py-2 pr-4'>${fmt(d.dmg)}</td>
                    <td class='py-2'>${fmt(d.frags)}</td>`;
    tbody.appendChild(tr);
  });

  const labels = res.deltas.map(d=>d.name);
  const battles = res.deltas.map(d=>d.battles);
  upsert('recent', document.getElementById('recentChart'), {
    type:'bar',
    data:{ labels, datasets:[{ label:'Bitvy', data:battles, backgroundColor: battles.map(()=> COLORS.battles) }] },
    options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
  });

  $('#snapInfo').innerHTML =
    `Souhrn: <b>${fmt(res.tot.battles)}</b> bitev, výhry <b>${fmt(res.tot.wins)}</b>, DMG <b>${fmt(res.tot.dmg)}</b>, fragy <b>${fmt(res.tot.frags)}</b>.<br>
     Interval: ${res.since} → ${res.until}`;
}

// Autofocus / deep link
document.addEventListener('DOMContentLoaded', ()=>{
  const p=new URL(location.href).searchParams.get('player');
  if(p){ $('#playerInput').value=p; document.getElementById('searchBtn').click(); } else { $('#playerInput').focus(); }
  if(window.lucide) lucide.createIcons();
});
</script>
</body>
</html>
